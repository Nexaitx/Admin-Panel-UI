<mat-drawer-container class="h-100" autosize>

  <mat-drawer #drawer mode="over" position="end" [opened]="isDrawerOpen" (closedStart)="onDrawerClosed()">
    <div class="drawer-content p-3">
      <h2>{{ getDrawerTitle() }}</h2>

      <ng-container *ngIf="selectedItem">

        <!-- If we are in cart tab -->
        <ng-container *ngIf="isCartItem(); else processedTemplate">
          <p><strong>Cart ID:</strong> {{ selectedItem.id }}</p>
          <p><strong>Product Name:</strong> {{ selectedItem.productName }}</p>
          <p><strong>Quantity:</strong> {{ selectedItem.quantity }}</p>
          <p><strong>Unit Price:</strong> {{ selectedItem.price | number:'1.2-2' }}</p>
          <p><strong>Total Price:</strong> {{ selectedItem.totalPrice | number:'1.2-2' }}</p>
          <p><strong>Product Type:</strong> {{ selectedItem.productType }}</p>
          <p><strong>Added Date:</strong> {{ selectedItem.addedDate | date:'medium' }}</p>
          <p><strong>User ID:</strong> {{ selectedItem.userId }}</p>
          <p><strong>User Name:</strong> {{ selectedItem.userName }}</p>
          <p><strong>User Email:</strong> {{ selectedItem.userEmail }}</p>
          <p><strong>User Phone:</strong> {{ selectedItem.userPhoneNumber }}</p>
          <p><strong>Brand Name:</strong> {{ selectedItem.brandName }}</p>
          <p><strong>Manufacturer:</strong> {{ selectedItem.manufacturer || 'N/A' }}</p>
          <p><strong>Dosage:</strong> {{ selectedItem.dosage }}</p>
          <p><strong>Product Form:</strong> {{ selectedItem.productForm }}</p>
          <ng-container *ngIf="selectedItem.imageUrl">
            <p><strong>Image:</strong></p>
            <img [src]="selectedItem.imageUrl" alt="Product image" style="max-width: 100%;" />
          </ng-container>
        </ng-container>

        <ng-template #processedTemplate>
          <!-- For processed orders (orderItems) -->
          <p><strong>Order Item ID:</strong> {{ selectedItem.orderItemId }}</p>
          <p><strong>Product ID:</strong> {{ selectedItem.productId }}</p>
          <p><strong>Product Name:</strong> {{ selectedItem.productName }}</p>
          <p><strong>Product Type:</strong> {{ selectedItem.productType }}</p>
          <p><strong>Packaging:</strong> {{ selectedItem.packaging }}</p>
          <p><strong>Product Form:</strong> {{ selectedItem.productForm }}</p>
          <p><strong>Quantity:</strong> {{ selectedItem.quantity }}</p>
          <p><strong>Unit Price:</strong> {{ selectedItem.unitPrice | number:'1.2-2' }}</p>
          <p><strong>Total Price:</strong> {{ selectedItem.totalPrice | number:'1.2-2' }}</p>
          <p><strong>Brand Name:</strong> {{ selectedItem.brandName }}</p>
          <p><strong>Manufacturer:</strong> {{ selectedItem.manufacturer }}</p>
          <p><strong>Dosage:</strong> {{ selectedItem.dosage }}</p>
          <ng-container *ngIf="selectedItem.imageUrl">
            <p><strong>Image:</strong></p>
            <img [src]="selectedItem.imageUrl" alt="Product image" style="max-width: 100%;" />
          </ng-container>
        </ng-template>

      </ng-container>

      <button mat-raised-button color="primary" (click)="closeDrawer()">Close</button>
    </div>
  </mat-drawer>
  <mat-drawer-content>
    <mat-tab-group (selectedTabChange)="onTabChange($event)" [(selectedIndex)]="activeTabIndex"
      animationDuration="300ms">

      <mat-tab label="Orders in Cart">
        <div class="tab-content pt-3">
          <div class="toolbar d-flex align-items-center mb-2">
            <mat-icon>filter_list</mat-icon>

            <mat-form-field appearance="outline" class="ms-2 small-select">
              <mat-label>Search Cart</mat-label>
              <input matInput (keyup)="applyCartFilter($event)" placeholder="Search by product, customer, etc.">
            </mat-form-field>

            <mat-paginator class="ms-auto" #cartPaginator [pageSizeOptions]="[5, 10, 20, 100]" showFirstLastButtons>
            </mat-paginator>
          </div>
          <section>
            <table mat-table [dataSource]="cartOrders" matSort #cartSort="matSort">

              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Cart ID </th>
                <td mat-cell *matCellDef="let item"> {{ item.id }} </td>
              </ng-container>

              <ng-container matColumnDef="productName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Product Name </th>
                <td mat-cell *matCellDef="let item"> {{ item.productName }} </td>
              </ng-container>

              <ng-container matColumnDef="brandName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Brand </th>
                <td mat-cell *matCellDef="let item"> {{ item.brandName || 'N/A' }} </td>
              </ng-container>

              <ng-container matColumnDef="dosage">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Dosage </th>
                <td mat-cell *matCellDef="let item"> {{ item.dosage }} </td>
              </ng-container>

              <ng-container matColumnDef="productForm">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Form </th>
                <td mat-cell *matCellDef="let item"> {{ item.productForm }} </td>
              </ng-container>

              <ng-container matColumnDef="quantity">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Qty </th>
                <td mat-cell *matCellDef="let item"> {{ item.quantity }} </td>
              </ng-container>

              <ng-container matColumnDef="price">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Price </th>
                <td mat-cell *matCellDef="let item"> {{ item.price | number:'1.2-2' }} </td>
              </ng-container>

              <ng-container matColumnDef="totalPrice">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
                <td mat-cell *matCellDef="let item"> {{ item.totalPrice | number:'1.2-2' }} </td>
              </ng-container>

              <ng-container matColumnDef="userName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Customer </th>
                <td mat-cell *matCellDef="let item"> {{ item.userName }} </td>
              </ng-container>

              <ng-container matColumnDef="addedDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Added Date </th>
                <td mat-cell *matCellDef="let item">
                  {{ item.addedDate | date:'medium' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="actions" stickyEnd>
                <th mat-header-cell *matHeaderCellDef> Actions </th>
                <td mat-cell *matCellDef="let item">
                  <button mat-icon-button color="primary" (click)="onView(item)">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="cartColumns; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: cartColumns;"></tr>
            </table>
          </section>

        </div>
      </mat-tab>

      <mat-tab label="Processed Orders">
        <div class="tab-content pt-3">
          <div class="toolbar d-flex align-items-center mb-2">
            <mat-icon>filter_list</mat-icon>
            <mat-form-field appearance="outline" class="ms-2 small-select">
              <mat-label>Filter by Status</mat-label>
              <mat-select [(value)]="selectedOrderType" (selectionChange)="onOrderTypeChange($event.value)">
                @for (type of orderStatuses; track type.value) {
                <mat-option [value]="type.value">
                  {{ type.label | titlecase }}
                </mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="ms-2 small-select">
              <mat-label>Search Orders</mat-label>
              <input matInput (keyup)="applyProcessedFilter($event)" placeholder="Search by order ID, customer, etc.">
            </mat-form-field>
            <mat-paginator class="ms-auto" #processedPaginator [pageSizeOptions]="[5, 10, 20, 100]" showFirstLastButtons>
            </mat-paginator>
          </div>

          <!-- Processed orders table -->
          <section>
            <table mat-table [dataSource]="processedOrders" matSort #processedSort="matSort">
              <!-- All original columns -->
              <ng-container matColumnDef="orderId" sticky="true">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Order ID </th>
                <td mat-cell *matCellDef="let item"> {{ item.orderId }} </td>
              </ng-container>

              <ng-container matColumnDef="orderNumber" sticky="true">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Order Number </th>
                <td mat-cell *matCellDef="let item"> {{ item.orderNumber }} </td>
              </ng-container>

              <ng-container matColumnDef="userId">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> User ID </th>
                <td mat-cell *matCellDef="let item"> {{ item.userId }} </td>
              </ng-container>

              <ng-container matColumnDef="userName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> User Name </th>
                <td mat-cell *matCellDef="let item"> {{ item.userName }} </td>
              </ng-container>

              <ng-container matColumnDef="userPhoneNumber">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Phone </th>
                <td mat-cell *matCellDef="let item"> {{ item.userPhoneNumber }} </td>
              </ng-container>

              <ng-container matColumnDef="userEmail">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Email </th>
                <td mat-cell *matCellDef="let item"> {{ item.userEmail }} </td>
              </ng-container>

              <ng-container matColumnDef="paymentStatus">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Payment Status </th>
                <td mat-cell *matCellDef="let item"> {{ item.paymentStatus }} </td>
              </ng-container>

              <ng-container matColumnDef="orderDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Order Date </th>
                <td mat-cell *matCellDef="let item"> {{ item.orderDate | date: 'medium' }} </td>
              </ng-container>

              <ng-container matColumnDef="expectedDeliveryDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Delivery Date </th>
                <td mat-cell *matCellDef="let item"> {{ item.expectedDeliveryDate | date: 'medium' }} </td>
              </ng-container>

              <ng-container matColumnDef="finalAmount">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Final Amount </th>
                <td mat-cell *matCellDef="let item">{{ item.finalAmount | number:'1.2-2' }} </td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
                <td mat-cell *matCellDef="let item"> {{ item.status }} </td>
              </ng-container>

              <ng-container matColumnDef="taxAmount">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Tax </th>
                <td mat-cell *matCellDef="let item"> {{ item.taxAmount | number:'1.2-2' }} </td>
              </ng-container>

              <ng-container matColumnDef="totalAmount">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
                <td mat-cell *matCellDef="let item"> {{ item.totalAmount | number:'1.2-2' }} </td>
              </ng-container>

              <ng-container matColumnDef="actions" stickyEnd>
                <th mat-header-cell *matHeaderCellDef> Actions </th>
                <td mat-cell *matCellDef="let item">
                  <button mat-icon-button color="primary" (click)="onView(item)">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="processedColumns; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: processedColumns;"></tr>
            </table>
          </section>


        </div>
      </mat-tab>

    </mat-tab-group>
  </mat-drawer-content>
</mat-drawer-container>