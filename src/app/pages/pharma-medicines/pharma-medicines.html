<mat-drawer-container class="med-container" autosize>
  <mat-drawer class="w-75 p-4" #drawer mode="over" position="end" [disableClose]="false">
    <h3>{{ editing ? 'Edit Medicine Request' : 'Add Medicine Request' }}</h3>
    <form [formGroup]="medicineForm" (ngSubmit)="onSubmit()">
      <div class="row">
        <!-- Name -->
        <mat-form-field class="col-md-6" appearance="outline">
          <mat-label>Medicine Name</mat-label>
          <input matInput formControlName="name" />
        </mat-form-field>

        <!-- Description -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description"></textarea>
        </mat-form-field>

        <!-- Price -->
        <mat-form-field class="col-md-6" appearance="outline">
          <mat-label>Price</mat-label>
          <input matInput type="number" formControlName="price" min="1" />
        </mat-form-field>

        <!-- Quantity in stock -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Quantity In Stock</mat-label>
          <input matInput type="number" formControlName="quantityInStock" min="0" />
        </mat-form-field>

        <!-- Category -->
        <mat-form-field class="col-md-6" appearance="outline">
          <mat-label>Category</mat-label>
          <input matInput formControlName="category" />
        </mat-form-field>

        <!-- Manufacturer -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Manufacturer</mat-label>
          <input matInput formControlName="manufacturer" />
        </mat-form-field>

        <!-- Expiry Date -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Expiry Date</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="expiryDate">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <!-- Gender Restriction -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Gender Restriction</mat-label>
          <input matInput formControlName="genderRestriction" />
        </mat-form-field>

        <!-- Min Age -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Min Age</mat-label>
          <input matInput type="number" formControlName="minAge" min="0" />
        </mat-form-field>

        <!-- Max Age -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Max Age</mat-label>
          <input matInput type="number" formControlName="maxAge" min="0" />
        </mat-form-field>

        <!-- Uses -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Uses</mat-label>
          <textarea matInput formControlName="uses"></textarea>
        </mat-form-field>

        <!-- Precautions -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Precautions</mat-label>
          <textarea matInput formControlName="precautions"></textarea>
        </mat-form-field>

        <!-- Side Effects -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Side Effects</mat-label>
          <textarea matInput formControlName="sideEffects"></textarea>
        </mat-form-field>

        <!-- Brand Name -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Brand Name</mat-label>
          <input matInput formControlName="brandName" />
        </mat-form-field>

        <!-- Dosage -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Dosage</mat-label>
          <input matInput formControlName="dosage" />
        </mat-form-field>

        <!-- Product Form -->
        <mat-form-field class="col-md-6" appearance="outline">
          <mat-label>Product Form</mat-label>
          <input matInput formControlName="product_form" />
        </mat-form-field>

        <!-- Prescription Required -->
        <mat-slide-toggle class="col-md-6 mb-3 d-none" formControlName="prescription_required">
          Prescription Required
        </mat-slide-toggle>

        <!-- Show In App -->
        <mat-slide-toggle class="col-md-6 mb-3 d-none" formControlName="showInApp">
          Show In App
        </mat-slide-toggle>

        <!-- How to Use -->
        <mat-form-field class="col-md-12 d-none" appearance="outline">
          <mat-label>How to Use</mat-label>
          <textarea matInput formControlName="how_to_use"></textarea>
        </mat-form-field>

        <!-- Safety Advice -->
        <mat-form-field class="col-md-12 d-none" appearance="outline">
          <mat-label>Safety Advice</mat-label>
          <textarea matInput formControlName="safety_advise"></textarea>
        </mat-form-field>

        <!-- Common Side Effects -->
        <mat-form-field class="col-md-12 d-none" appearance="outline">
          <mat-label>Common Side Effects</mat-label>
          <textarea matInput formControlName="common_side_effec"></textarea>
        </mat-form-field>

        <!-- Pregnancy Interaction -->
        <mat-form-field class="col-md-12 d-none" appearance="outline">
          <mat-label>Pregnancy Interaction</mat-label>
          <textarea matInput formControlName="pregnancy_interaction"></textarea>
        </mat-form-field>

        <!-- How It Works -->
        <mat-form-field class="col-md-12 d-none" appearance="outline">
          <mat-label>How It Works</mat-label>
          <textarea matInput formControlName="how_it_works"></textarea>
        </mat-form-field>

        <!-- Storage -->
        <mat-form-field class="col-md-12 d-none" appearance="outline">
          <mat-label>Storage</mat-label>
          <textarea matInput formControlName="storage"></textarea>
        </mat-form-field>

        <!-- Medicine Type -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Medicine Type</mat-label>
          <input matInput formControlName="medicine_type" />
        </mat-form-field>

        <!-- Salt Composition -->
        <mat-form-field class="col-md-6 d-none" appearance="outline">
          <mat-label>Salt Composition</mat-label>
          <input matInput formControlName="salt_composition" />
        </mat-form-field>

        <!-- Images -->
        <div class="col-md-12">
          <label>Images</label>
          <div *ngIf="medicineForm && images" formArrayName="images">
            <div *ngFor="let imgCtrl of images.controls; let i = index" class="d-flex align-items-center mb-2">
              <!-- Display existing image URL as a preview -->
              <ng-container *ngIf="imgCtrl.value && typeof imgCtrl.value === 'string'">
                <img [src]="imgCtrl.value" alt="Medicine Image" width="50" style="margin-right: 8px;" />
              </ng-container>
              <!-- Display file input for new uploads or allow replacing existing -->
              <input type="file" [formControlName]="i" (change)="onFileSelected($event, i)" />
              <button mat-icon-button class="text-danger" type="button" (click)="removeImageControl(i)"
                aria-label="Remove this image">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <button type="button" class="my-2" mat-button (click)="addImageControl()">
            <i class="bi bi-plus"></i> Add Image
          </button>
        </div>

      </div>

      <div class="button-row d-flex justify-content-between mt-4">
        <button mat-button (click)="drawer.close()">Cancel</button>
        <button mat-flat-button color="primary" type="submit" [disabled]="medicineForm.invalid">
          Submit
        </button>
      </div>
    </form>
  </mat-drawer>

  <mat-drawer-content>
    <div class="row mt-2">
      <mat-form-field appearance="outline" class="small-select col-md-3">
        <mat-label>Select Orders</mat-label>
        <mat-select [(value)]="selectedMedicineType" (selectionChange)="onMedicineTypeChange($event.value)">
          <mat-option value="" disabled>Select Medicine Type</mat-option>
          <mat-option value="">Ethical Medicines</mat-option>
          <mat-option value="otc">OTC Medicines</mat-option>
          <mat-option value="medicines">Generic Medicines</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="small-select col-md-3">
        <mat-label>Select Availability</mat-label>
        <mat-select [(value)]="selectedAvailability" (selectionChange)="onAvailabilityChange($event.value)">
          <mat-option value="" disabled>Select Availability</mat-option>
          <mat-option value="true">Available medicines</mat-option>
          <mat-option value="false">Non Available medicines</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-slide-toggle class="col-md-3 col-sm-5 col-6 mb-3" [checked]="checkedToggle"
        (change)="toggleDiscountedMedicines($event)">
        Check Discounted Medicines
      </mat-slide-toggle>

      <button class="col-md-2 mx-2 col-sm-5 col-6" matButton="tonal" (click)="editing = false; openCreate()">
        Add Medicine request</button>

      <ng-template #bulkDialog>
        <h2 mat-dialog-title>Confirm Bulk Update</h2>
        <mat-dialog-content class="py-2">
          <p>You're updating <strong>{{ dialogSelectedCount }}</strong> selected product(s).</p>

          <mat-form-field appearance="outline" style="width:100%">
            <mat-label>Discount % (leave empty to keep current/edit value)</mat-label>
            <input matInput type="number" [(ngModel)]="dialogBulkDiscount" placeholder="e.g. 10" />
          </mat-form-field>

          <mat-label class="me-2">Selected Medicines Availability</mat-label><br>
          <mat-radio-group [(ngModel)]="dialogBulkStatus" [ngModelOptions]="{standalone: true}"
            class="d-flex align-items-center">
            <mat-radio-button [value]="true" class="me-2">Available</mat-radio-button>
            <mat-radio-button [value]="false">Unavailable</mat-radio-button>
          </mat-radio-group>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
          <button mat-button mat-dialog-close>Cancel</button>
          <button mat-flat-button color="primary"
            [mat-dialog-close]="{ confirmed: true, discount: dialogBulkDiscount, status: dialogBulkStatus }">Confirm</button>
        </mat-dialog-actions>
      </ng-template>

    </div>
    <div class="d-flex justify-content-between">
      <div>
        <mat-form-field appearance="outline">
          <mat-label>Search Orders</mat-label>
          <input matInput (keyup)="applySearchFilter($event)" placeholder="Search by medicine">
        </mat-form-field>

        <button class="ms-2" matButton="tonal" [disabled]="selection.selected.length === 0" (click)="openBulkDialog()">
          Bulk Update</button>
      </div>

      <mat-paginator [pageSizeOptions]="[5, 10, 20, 100]" showFirstLastButtons></mat-paginator>
    </div>
    <section>
      <table mat-table [dataSource]="dataSource" matSort>
        <ng-container matColumnDef="select" sticky>
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="$event ? toggleAllRows() : null" [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row" sticky>
            <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? toggleSelection(row) : null"
              [checked]="selection.isSelected(row)" [aria-label]="checkboxLabel(row)">
            </mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="s_no" sticky>
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="ps-0"> S.No </th>
          <td mat-cell *matCellDef="let element; let i = index">
            {{ i + 1 }}
          </td>
        </ng-container>

        <ng-container matColumnDef="medicineId">
          <th mat-header-cell *matHeaderCellDef>Product&nbsp;ID</th>
          <td mat-cell *matCellDef="let m">{{ m.medicineId || m?.productId || m?.id }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Medicine&nbsp;Name</th>
          <td mat-cell *matCellDef="let m">{{ m.name || m?.productName }}</td>
        </ng-container>

        <ng-container matColumnDef="category">
          <th mat-header-cell *matHeaderCellDef>Category</th>
          <td mat-cell *matCellDef="let m">{{ m.category || m?.medicineType }}</td>
        </ng-container>

        <ng-container matColumnDef="quantityInStock">
          <th mat-header-cell *matHeaderCellDef>Unit</th>
          <td mat-cell *matCellDef="let m">{{ m.quantityInStock }}</td>
        </ng-container>

        <ng-container matColumnDef="mrp">
          <th mat-header-cell *matHeaderCellDef>MRP</th>
          <td mat-cell *matCellDef="let m">{{ m.mrp || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="discountPercentage">
          <th mat-header-cell *matHeaderCellDef>Discount&nbsp;%</th>
          <td mat-cell *matCellDef="let m">
            <ng-container *ngIf="m._editing; else readDiscount">
              <input matInput type="number" [(ngModel)]="m._editedDiscount" style="width:100px" />
            </ng-container>
            <ng-template #readDiscount>{{ m.discountPercentage || '—' }}</ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Vitoxyz&nbsp;Price</th>
          <td mat-cell *matCellDef="let m">{{ m.newDiscountPrice }}</td>
        </ng-container>

        <ng-container matColumnDef="active">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let m">
            <mat-slide-toggle
              [checked]="m._editing ? (m._editedAvailable ?? (m.showInApp ?? m.active)) : (m.showInApp ?? m.active)"
              [disabled]="!m._editing"
              (change)="onToggleChange(m, $event.checked)">
            </mat-slide-toggle>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions" stickyEnd>
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let m">
            <div class="d-flex">
              <button matButton="tonal" *ngIf="editingRow !== m" (click)="onEdit(m)" class="btn-sm btn-height-adjust">
                Edit
              </button>
              <button matButton="tonal" *ngIf="editingRow === m" (click)="onSave(m)" class="btn-sm btn-height-adjust">
                Submit
              </button>
            </div>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedManualMedicineColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedManualMedicineColumns;"></tr>
      </table>
    </section>
  </mat-drawer-content>